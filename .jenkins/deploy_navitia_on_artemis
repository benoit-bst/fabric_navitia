pipeline {
    agent any
    stages {
        stage('Install requirement to retreive Github artifacts') {
            steps {
                sh '''
                    pip install -r scripts/requirements.txt
                '''
            }
        }
        stage('Debian packages name') {
            steps {
                script {
                    if (env.PLATFORM == 'dev_debian8') {
                        env.NAVITIA_DEBIAN_PACKAGES = "navitia-debian8-packages.zip"
                    } else if (env.PLATFORM == 'dev_debian10') {
                        env.NAVITIA_DEBIAN_PACKAGES = "navitia-debian10-packages.zip"
                    } else if (env.PLATFORM == 'artemis_debian8') {
                        env.NAVITIA_DEBIAN_PACKAGES = "navitia-debian8-packages.zip"
                    } else {
                        echo 'selected platform not available'
                    }
                }
                sh 'echo ${NAVITIA_DEBIAN_PACKAGES} "is selected"'
            }
        }
        stage('remove old navitia debian packages') {
            steps {
                sh '''
                    echo "remove old artifacts from" ${NAVITIA_DEBIAN_PACKAGES}
                    python2.7 scripts/retreive_debian_packages_from_github.py -r ${NAVITIA_DEBIAN_PACKAGES}
                '''
            }
        }
        stage('process navitia debian packages') {
            steps {
                withCredentials([string(credentialsId: 'jenkins-core-github-access-token', variable: 'GITHUB_TOKEN')]) {
                    sh '''
                        echo "retreive debian packages for navitia deployment"
                        python2.7 scripts/retreive_debian_packages_from_github.py -u jenkins-kisio-core -t $GITHUB_TOKEN -w "Build Navitia Packages For Dev Multi Distributions" -a ${NAVITIA_DEBIAN_PACKAGES} -o "."
                    '''
                }
            }
        }
        stage('unzip navitia debian packages bundle') {
            steps {
                sh '''
                    echo "unzip" ${NAVITIA_DEBIAN_PACKAGES}
                    python2.7 scripts/retreive_debian_packages_from_github.py -z ${NAVITIA_DEBIAN_PACKAGES}
                '''
            }
        }
        stage('Retreive deployment configuration') {
            steps {
                sh 'rm -rf navitia_deployment_conf && mkdir -p navitia_deployment_conf' 
                dir('navitia_deployment_conf') {
                    git credentialsId: 'jenkins-core-ssh', url: 'git@github.com:CanalTP/navitia_deployment_conf.git'
                }
            }
        }
        stage('Install requirement for fabric deployment') {
            steps {
                sh '''
                    pip install -r requirements.txt --exists-action w
                '''
            }
        }
        stage('Run deployment') {
            steps {
                script {
                    if (env.PLATFORM == 'dev_debian8') {
                        echo 'deploy on dev - debian 8 platform'
                        sh '''
                            PYTHONPATH=navitia_deployment_conf/ python -u -m fabric use:dev upgrade_all:check_version=False
                        '''
                    } else if (env.PLATFORM == 'dev_debian10') {
                        echo 'deploy on dev - debian 10 platform'
                        echo 'Not implemented yet !!!!!'
                    } else if (env.PLATFORM == 'artemis_debian8') {
                        echo 'deploy on artemis - debian 8 platform'
                        sh '''
                            PYTHONPATH=navitia_deployment_conf/ python -u -m fabric use:artemis upgrade_version
                            PYTHONPATH=navitia_deployment_conf/ python -u -m fabric use:artemis update_all_configurations:restart=false
                        '''
                    } else {
                        echo 'platform not available'
                    }
                }
            }
        }
    }
    post {
        failure { 
            withCredentials([string(credentialsId: 'navitia_core_team_slack_chan', variable: 'NAVITIA_CORE_TEAM_SLACK_CHAN')]) {
                sh '''
                    curl -X POST -H 'Content-type: application/json' --data '{"text":":warning: Deploy Navitia on Artemis is failed"}' NAVITIA_CORE_TEAM_SLACK_CHAN
                '''
            }
        }
    }
}
